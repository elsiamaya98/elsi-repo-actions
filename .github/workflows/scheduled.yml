name: VerificaciÃ³n Programada

# Este workflow se ejecuta automÃ¡ticamente segÃºn un schedule
on:
  schedule:
    # Cron syntax: minuto hora dÃ­a mes dÃ­a-de-la-semana
    # Ejecutar todos los dÃ­as a las 8:00 AM UTC
    - cron: '0 8 * * *'
    
    # Ejecutar cada lunes a las 9:00 AM UTC
    # - cron: '0 9 * * 1'
    
    # Ejecutar cada hora
    # - cron: '0 * * * *'
  
  # TambiÃ©n permite ejecuciÃ³n manual
  workflow_dispatch:

jobs:
  health-check:
    name: ğŸ¥ Health Check del Sistema
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3
      
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: ğŸ“¦ Instalar dependencias
        run: npm install
      
      - name: ğŸ¥ Ejecutar Health Check
        run: |
          echo "===================================="
          echo "ğŸ¥ INICIANDO HEALTH CHECK"
          echo "===================================="
          echo "Fecha y hora: $(date)"
          echo "===================================="
          
          # Ejecutar tests
          npm test
          
          echo "===================================="
          echo "âœ… Health Check completado exitosamente!"
          echo "Sistema funcionando correctamente"
          echo "===================================="
      
      - name: ğŸ“Š EstadÃ­sticas del sistema
        run: |
          echo "===================================="
          echo "ESTADÃSTICAS DEL RUNNER"
          echo "===================================="
          echo "Uptime del sistema:"
          uptime
          echo "===================================="
          echo "Uso de disco:"
          df -h | grep -E "Filesystem|/dev/root"
          echo "===================================="
          echo "Memoria disponible:"
          free -h
          echo "===================================="
          echo "Procesos activos:"
          ps aux | wc -l
          echo "===================================="

  scheduled-test:
    name: ğŸ§ª Tests Programados
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3
      
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: ğŸ“¦ Instalar dependencias
        run: npm install
      
      - name: ğŸ§ª Ejecutar suite de tests
        run: npm test
      
      - name: ğŸ“ Log del resultado
        if: always()
        run: |
          echo "===================================="
          echo "REGISTRO DE EJECUCIÃ“N PROGRAMADA"
          echo "===================================="
          echo "Workflow: ${{ github.workflow }}"
          echo "Ejecutado: $(date)"
          echo "Disparador: ${{ github.event_name }}"
          echo "Repositorio: ${{ github.repository }}"
          echo "===================================="

  notify-status:
    name: ğŸ“¬ NotificaciÃ³n de Estado
    needs: [health-check, scheduled-test]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“¬ Estado de la verificaciÃ³n
        run: |
          echo "===================================="
          echo "RESUMEN DE VERIFICACIÃ“N PROGRAMADA"
          echo "===================================="
          echo "Fecha: $(date)"
          echo "Estado de health-check: ${{ needs.health-check.result }}"
          echo "Estado de scheduled-test: ${{ needs.scheduled-test.result }}"
          echo "===================================="
          
          if [ "${{ needs.health-check.result }}" == "success" ] && [ "${{ needs.scheduled-test.result }}" == "success" ]; then
            echo "âœ… Todos los checks pasaron exitosamente"
          else
            echo "âš ï¸ Algunos checks fallaron - revisar logs"
            exit 1
          fi
          echo "===================================="

# NOTAS SOBRE CRON SYNTAX:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ minuto (0 - 59)
# â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ hora (0 - 23)
# â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ dÃ­a del mes (1 - 31)
# â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ mes (1 - 12)
# â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ dÃ­a de la semana (0 - 6) (Domingo = 0)
# â”‚ â”‚ â”‚ â”‚ â”‚
# * * * * *
#
# Ejemplos Ãºtiles:
# '0 0 * * *'     - Diario a medianoche
# '0 */6 * * *'   - Cada 6 horas
# '0 9 * * 1-5'   - 9 AM de Lunes a Viernes
# '0 0 1 * *'     - Primer dÃ­a de cada mes a medianoche
# '*/15 * * * *'  - Cada 15 minutos
